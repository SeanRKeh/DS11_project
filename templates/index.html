<!doctype html>
<html>
    <head>
        <!-- bootstrap 
        Replaced with a more updated (version 5.2.1) of bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">

        <!-- Bootstap icons-->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">

        <!-- vegalite -->
        <script src="https://cdn.jsdelivr.net/npm/vega@5.20.2"></script>
        <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.1.0"></script>
        <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.17.0"></script>

        <!-- leaflet -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>

        <!-- leaflet control geocoder -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

        <!-- leaflet fullscreen -->
        <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
        <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />

        <!-- autocomplete -->
        <script src="https://cdn.jsdelivr.net/gh/tomik23/autocomplete@1.8.5/dist/js/autocomplete.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tomik23/autocomplete@1.8.5/dist/css/autocomplete.min.css"/>

        <!-- web css -->
        <link rel="stylesheet" href="{{ url_for('static', filename= 'css/style.css') }}">

        <!-- title -->
        <title>DS11 Web App</title>
    </head>

    <style>
      /*The styles here are used for test purposes*/

      /*Marker clicked popup*/


      .marker-close-button {
        cursor: pointer;
        position: absolute;
        top: 30px;
        right: 40px;
        border: none;
        padding: 5px;
        font-size: 35px;
        -webkit-text-stroke: 1px rgb(0, 0, 0);
        margin: 0;
        padding: 0;
        border-radius: 3px;
        background: none;
        opacity: 0;
      }

      .active-marker-popup .marker-close-button {
        opacity: 1;
      }

      .active-marker-popup .marker-popup {
        max-width: 768px;
        right: 0%;
        z-index: 99999;
        bottom: 0px;
      }

      .marker-popup{
        position: absolute;
        background-color:#fff;
        max-height: 600px;
        height: 100%;
        overflow: hidden;
        display: none;
        transform:translate(0%);
        padding: 35px 55px;
        border-radius: 30px 30px 0 0;
        font-family: 'Poppins',sans-serif;
        border: 5px solid rgba(17, 17, 17, 0.3)
      }

      @media (min-width: 768px) {
        .marker-popup {
          transition: transform 0.3s ease-in-out;
          transform:translate(50%);
        }

        .active-marker-popup .marker-popup {
          max-height: 600px;
          height: 100%;
          max-width: 1100px;
          width: 100%;
          display: block;
          transition: transform 0.3 ease-in-out;
          
          right:50%;
        }
        /* This is used to control where the leaflet-bottom controls go once the marker is clicked (its active).... feel free to comment this code snippet out to see it in action*/
        /*
        .active-marker-popup .leaflet-bottom {
          transform: translateY(-485px);
          transition: transform 350ms;
        }
        */
      }

    </style>
    <body>
        <!-- doesn't work btw 
        <button onclick="BackToTop()" id="topbtn">Up</button>
        -->

        <!-------------------------------------------------------------->
        <!-------------------------------------------------------------->
        <!-------------------------------------------------------------->
        <!-- Create popup when a non-police marker is clicked-->
        <div class="marker-popup">
          <button class="marker-close-button" onclick= "markerClose()">
            <i class="bi bi-x-lg"></i>
          </button>
          <div>
            <h2 id="marker-title" class="marker-title">
              Cale Jane Sullivan Marker reports
            </h1>
            <h5 id="marker-danger-rating" class="card-subtitle mb-2 text-muted marker-danger-rating">
              Current Danger Rating: 5
            </h5>
            <h5 id="marker-area-recc" class="marker-area-recc">
              Do we recommend going to this area: NO
            </h5>
          </div>
          <div class="data-vis-content">
            <!--Insert content here-->
            <div class='tableauPlaceholder' id='viz1665573653419' style='position: relative'>
              <noscript>
                <a href='#'><img alt='OFFENCE LGA RATE REPORT ' src='https:&#47;&#47;public.tableau.com&#47;static&#47;images&#47;Re&#47;Report_V2_test&#47;3&#47;1_rss.png' style='border: none' /></a>
              </noscript>
              <object class='tableauViz'  style='display:none;'>
                <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' /> 
                <param name='embed_code_version' value='3' /> 
                <param name='site_root' value='' />
                <param name='name' value='Report_V2_test&#47;3' />
                <param name='tabs' value='no' />
                <param name='toolbar' value='yes' />
                <param name='static_image' value='https:&#47;&#47;public.tableau.com&#47;static&#47;images&#47;Re&#47;Report_V2_test&#47;3&#47;1.png' /> 
                <param name='animate_transition' value='yes' />
                <param name='display_static_image' value='yes' />
                <param name='display_spinner' value='yes' />
                <param name='display_overlay' value='yes' />
                <param name='display_count' value='yes' />
                <param name='language' value='en-US' />
                <param name='device' value='mobile' />
                <param name='device' value='desktop' />
              </object>
            </div>                
            <script type='text/javascript'>                    
              var divElement = document.getElementById('viz1665573653419');                    
              var vizElement = divElement.getElementsByTagName('object')[0];                    
              if ( divElement.offsetWidth > 800 ) { 
                vizElement.style.width='1200px';
                vizElement.style.height='1227px';
              } else if ( divElement.offsetWidth > 500 ) { 
                vizElement.style.width='1200px';
                vizElement.style.height='1227px';
              } else { 
                vizElement.style.width='100%';
                vizElement.style.height='2027px';
              }                     
              var scriptElement = document.createElement('script');                    
              scriptElement.src = 'https://public.tableau.com/javascripts/api/viz_v1.js';                    
              vizElement.parentNode.insertBefore(scriptElement, vizElement);                
            </script>
          </div>
        </div>

        <!-------------------------------------------------------------->
        <!-------------------------------------------------------------->
        <!-------------------------------------------------------------->
        <!-- Map and review and report buttons -->
        <div id="map">
          <div class="leaflet-control userbuttons">
            <button type="button" onclick= "reportClicked()" class="btn btn-primary btn-circle reportbtn">Report</button>
            <button type="button" onclick = "reviewClicked()" class="btn btn-primary btn-circle reviewbtn">Review</button>
            <h2 id="DRating">0.0000</h2>
            <h5>Safety Rating</h5>
          </div>
        </div>


        <!-------------------------------------------------------------->
        <!-------------------------------------------------------------->
        <!-------------------------------------------------------------->

        <!-- Review Form -->
        <!-- .... 
        <div class="container" id="reviewForm" style="display: none;">

          <div class="py-4 text-center">
            <h4>Write a review</h4>
          </div>
          <div class="row g-4 p-3 border">
              <form>
                <div class="row g-3">                
                  <div class="col-12">
                    <label class= "form-label" for="inputDescription">How do you feel about this area</label>
                    <textarea type="description" class="form-control" id="inputDescription" placeholder="e.g. I have been in this area for ... and ..." rows="4" required></textarea>
                  </div>
      
                </div>
      
                <hr class="my-4">
      
                <div class="row g-3">
                  <div class="col-12">
                  <div class="form-group">
                    <label class="form-label" for="inputAreaDangerRating">How safe would you rate this area (1 - least safe): </label>
                    <br>
    
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="inputSafetyRating" id="inputSafetyRating1" value="option1" checked>
                      <label class="form-check-label" for="inputSafetyRating1">
                        1
                      </label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="inputSafetyRating" id="inputSafetyRating2" value="option2" >
                      <label class="form-check-label" for="inputSafetyRating2">
                        2
                      </label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="inputSafetyRating" id="inputSafetyRating3" value="option3" >
                      <label class="form-check-label" for="inputSafetyRating3">
                        3
                      </label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="inputSafetyRating" id="inputSafetyRating4" value="option4" >
                      <label class="form-check-label" for="inputSafetyRating4">
                        4
                      </label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="inputSafetyRating" id="inputSafetyRating5" value="option5" >
                      <label class="form-check-label" for="inputSafetyRating5">
                        5
                      </label>
                    </div>
                  </div>
                </div>
      
                <hr class="my-4">
                
                <div class="row px-4">
                  <button type="cancel" onclick="formEnd()" class="col-sm-12 col-lg-6 btn btn-danger btn-lg">Cancel</button>
                  <button type="submit" onclick="formEnd()" class="col-sm-12 col-lg-6 btn btn-primary btn-lg">Submit</button>
                </div>
                
              </form>
          </div>
        </div>
        -->

          
      </body>

        <!-- This is for test purposes
        <iframe src="{{ url_for('static', filename= 'html/reportform.html') }}" title="Report Form">
        </iframe>
        -->

        <!--
        <div id="Info_bubble"></div>
        -->

        <script type="text/javascript">
            /* doesn't work btw 
            topbtn = document.getElementById("topbtn");
            window.onscroll = function() {scrollFunction()};
            function scrollFunction() {
              if (document.body.scrollTop > 260 || document.documentElement.scrollTop > 260) {
                topbtn.style.display = "block";
              } else {
                topbtn.style.display = "block";
              }
            }

            function BackToTop() {
              document.documentElement.scrollTop = 0;
            }
            */
            
            var user_coord = 0;

            const policeMarkerData = {{policeStations | tojson}};
            const reportMarkerData = {{reports | tojson}};
            

            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //Create and initialize map
            var map = L.map('map', {
              // center: [-37.815, 144.964],
              center: [-37.813, 144.957],
              zoom: 17,
              minZoom: 5,
              maxZoom: 17,
              fullscreenControl: true,
            });

            const ini_bounds = map.getBounds();
            var ini_cnt = 0
            for (let i = 0; i < policeMarkerData.length; i++) {
              const curr_lat = policeMarkerData[i][7];
              const curr_lng = policeMarkerData[i][8];
              if (curr_lat >= ini_bounds._southWest.lat && curr_lat <= ini_bounds._northEast.lat && curr_lng >= ini_bounds._southWest.lng && curr_lng <= ini_bounds._northEast.lng) {
                ini_cnt++
              }
            };

            const ini_boundarea = (ini_bounds._northEast.lat - ini_bounds._southWest.lat) * (ini_bounds._northEast.lng - ini_bounds._southWest.lng)
            const pol_dense = ini_cnt/ini_boundarea;
            
            updateInfo();

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: 'Â© OpenStreetMap'
            }).addTo(map);


            //---------------------------------------------------------------
            //---------------------------------------------------------------
            // --------------------------------------------------------------
            // create seearch button

            // add "random" button
            const buttonTemplate = `<div class="auto-search-wrapper max-height"><input type="text" id="marker" autocomplete="off"  aria-describedby="instruction" aria-label="Search ..." /><div id="instruction" class="hidden">When autocomplete results are available use up and down arrows to review and enter to select. Touch device users, explore by touch or with swipe gestures.</div></div>`;

            // create custom button
            const customControl = L.Control.extend({
              // button position
              options: {
                position: "topright",
                className: "leaflet-autocomplete",
              },

              // method
              onAdd: function () {
                return this._initialLayout();
              },

              _initialLayout: function () {
                // create button
                const container = L.DomUtil.create(
                  "div",
                  "leaflet-bar " + this.options.className
                );

                L.DomEvent.disableClickPropagation(container);

                container.innerHTML = buttonTemplate;

                return container;
              },
            });

            // adding new button to map controll
            map.addControl(new customControl());

            // --------------------------------------------------------------

            // input element
            const root = document.getElementById("marker");
            root.placeholder = "Search ...";

            // function click on clear button
            function clickOnClearButton() {
              document.querySelector(".auto-clear").click();
            }

            // function clear input
            map.on("click", () => {
              document
                .querySelector(".leaflet-autocomplete")
                .classList.remove("active-autocomplete");

              clickOnClearButton();
            });

            // autocomplete section
            // more config find in https://github.com/tomik23/autocomplete
            // --------------------------------------------------------------

            new Autocomplete("marker", {
              delay: 250,
              selectFirst: true,
              howManyCharacters: 2,

              onSearch: function ({ currentValue }) {
                const api = `https://nominatim.openstreetmap.org/search?format=geojson&limit=5&q=${encodeURI(
                  currentValue
                )}`;

                /**
                 * Promise
                 */
                return new Promise((resolve) => {
                  fetch(api)
                    .then((response) => response.json())
                    .then((data) => {
                      resolve(data.features);
                    })
                    .catch((error) => {
                      console.error(error);
                    });
                });
              },

              onResults: ({ currentValue, matches, template }) => {
                const regex = new RegExp(currentValue, "i");
                // checking if we have results if we don't
                // take data from the noResults method
                return matches === 0
                  ? template
                  : matches
                      .map((element) => {
                        return `
                          <li role="option">
                            <p>${element.properties.display_name.replace(
                              regex,
                              (str) => `<b>${str}</b>`
                            )}</p>
                          </li> `;
                      })
                      .join("");
              },

              onSubmit: ({ object }) => {
                const { display_name } = object.properties;
                const cord = object.geometry.coordinates;
                // custom id for marker
                // const customId = Math.random();

                // remove last marker
                map.eachLayer(function (layer) {
                  if (layer.options && layer.options.pane === "markerPane") {
                    if (layer._icon.classList.contains("leaflet-marker-locate")) {
                      map.removeLayer(layer);
                    }
                  }
                });

                // add marker
                const marker = L.marker([cord[1], cord[0]], {
                  title: display_name,
                });

                // add marker to map
                marker.addTo(map).bindPopup(display_name);

                // set marker to coordinates
                map.flyTo([cord[1], cord[0]], 16);

                // add class to marker
                L.DomUtil.addClass(marker._icon, "leaflet-marker-locate");

                console.log(user_coord);
              },

              // the method presents no results
              noResults: ({ currentValue, template }) =>
                template(`<li>No results found: "${currentValue}"</li>`),
            });

            L.control.scale().addTo(map);
            
            // var marker = L.marker([-37.815, 144.964]).addTo(map);
            var marker = L.marker([-35, 143]).addTo(map);
            marker.bindPopup("<b>Hello world!</b><br>I am a centre popup.");

            //Bind the markerMenu function to this marker (for testing purposes)
            marker.on("click", openMarkerMenu);

            /* old search
            var geocoder = L.Control.geocoder({
              defaultMarkGeocode: false,
              collapsed: false,
              showUniqueResult: false,
              showResultIcons: true,
            })
              .on('markgeocode', function(e) {
                map.setView(center = e.geocode.center,16)
                var marker2 = L.marker(e.geocode.center).addTo(map);
                marker2.bindPopup(e.geocode.name).openPopup();
              })
              .addTo(map);
            */

            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //The report markers
            //Create a custom report marker
            reportMarker = L.Marker.extend({
            options: { 
                title: 'title',
                description: 'description',
                datetime: 'datetime',
                suburb_id: 'suburb_id',
                safety_level: 'safety_level',
                willingness_to_return: 'willingness_to_return'
              }
            });

            for (let i = 0; i < reportMarkerData.length; i++) {
              
              var repMarker = new reportMarker([reportMarkerData[i][5], reportMarkerData[i][6]], { 
                  title: reportMarkerData[i][1],
                  description: reportMarkerData[i][2],
                  datetime: reportMarkerData[i][3],
                  suburb_id: reportMarkerData[i][4],
                  safety_level: reportMarkerData[i][7],
                  willingness_to_return: reportMarkerData[i][8]
              });
              repMarker.addTo(map);
              repMarker.on("click", openMarkerMenu);
              console.log(repMarker);
            }
             

            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //The popup marker (for when a non-police marker is clicked) code
            
            //Function to open/close the marker
            function openMarkerMenu(e){
              target = e.target;
              
              var title = document.getElementById('marker-title');
              var dangerRating = document.getElementById('marker-danger-rating');
              var areaRecc = document.getElementById('marker-area-recc');

              title.innerHTML=target.options.title;
              dangerRating.innerHTML = "Danger rating of report: "+target.options.safety_level;
              areaRecc.innerHTML = "Willingness to return to the area: "+target.options.willingness_to_return;
              

              if (
                document.body.classList.contains("active-marker-popup")
                ) {
                  document.body.classList.remove("active-marker-popup");
              } else {
                  document.body.classList.add("active-marker-popup");
              }
                
            }
            //Function to close a marker popup using the close appeneded close button
            function markerClose(){
            
              document.body.classList.remove("active-marker-popup");
              
            }

            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //Create report and review button functionality

            //When report/review buttons are clicked
            function reportClicked() {


              //coordinates to send
              var coordToSend = {
                lat : user_coord.lat,
                lon : user_coord.lng
              };
              const params = new URLSearchParams({
                lat: user_coord.lat,
                lng: user_coord.lng,
              });
              console.log(params)
              window.location.replace("/reportform"+"?"+params.toString());

            }
            
            function reviewClicked() {
              window.location.replace("/reviewform");
            }

            /*
            function reviewClicked() {
              document.getElementById('map').style.display = "none";
              document.getElementById('reviewForm').style.display = "";
            }
            */

            //When any buttons on report/review forms are clicked
            function formEnd() {
              document.getElementById('map').style.display = "";
              document.getElementById('reportForm').style.display = "none";
              document.getElementById('reviewForm').style.display = "none";
            }
            
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //police markers things
            var PoliceIcon = L.icon({
              iconUrl: "https://raw.githubusercontent.com/qsun0018/3179/main/icon1.png",
              iconSize: [80, 80],
              iconAnchor: [20, 58],
              popupAnchor: [20, -30],
            });

            for (let i = 0; i < policeMarkerData.length; i++) {
              L.marker([policeMarkerData[i][7], policeMarkerData[i][8]], {icon:PoliceIcon}).addTo(map).bindPopup('<b>'+policeMarkerData[i][1]+' police station</b><br>'+'Address: '+policeMarkerData[i][3]+'<br>Phone Number: '+policeMarkerData[i][6])
            } 

            
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //current location
            map
              .locate({
                // https://leafletjs.com/reference-1.7.1.html#locate-options-option
                setView: true,
                enableHighAccuracy: true,
              })
              // if location found show marker and circle
              .on("locationfound", (e) => {
                console.log(e);
                // marker
                user_coord = e.latlng;
                const marker = L.marker([e.latitude, e.longitude]).bindPopup(
                  // "You are within " + e.accuracy + " metres from here"
                  "You are here"
                );
                // circle
                const circle = L.circle([e.latitude, e.longitude], e.accuracy / 2, {
                  weight: 2,
                  color: "red",
                  fillColor: "red",
                  fillOpacity: 0.1,
                });
                // add marker
                // map.addLayer(marker);
                updateInfo();
                // add circle
                // map.addLayer(circle);
                // setview custom
                // map.setView(center = [e.latitude, e.longitude], 13)
              })
              // if error show alert
              .on("locationerror", (e) => {
                console.log(e);
                alert("Location access denied.");
              });

            map.on("dragend", updateInfo);
            map.on("zoomend", updateInfo);

            function updateInfo() {
              const bounds = map.getBounds();
              var cnt = 0
              for (let i = 0; i < policeMarkerData.length; i++) {
                const pol_lat = policeMarkerData[i][7];
                const pol_lng = policeMarkerData[i][8];
                if (pol_lat >= bounds._southWest.lat && pol_lat <= bounds._northEast.lat && pol_lng >= bounds._southWest.lng && pol_lng <= bounds._northEast.lng) {
                  cnt++
                }
              };

              const boundarea = (bounds._northEast.lat - bounds._southWest.lat) * (bounds._northEast.lng - bounds._southWest.lng)
              // console.log(bounds);
              console.log((cnt/boundarea)/pol_dense);

              const rep_safety_arr = [];
              const rep_again_arr = [];
              for (let i = 0; i < reportMarkerData.length; i++) {
                const rep_lat = parseFloat(reportMarkerData[i][5]);
                const rep_lng = parseFloat(reportMarkerData[i][6]);
                if (rep_lat >= bounds._southWest.lat && rep_lat <= bounds._northEast.lat && rep_lng >= bounds._southWest.lng && rep_lng <= bounds._northEast.lng) {
                  rep_safety_arr.push(5-reportMarkerData[i][7]);
                  rep_again_arr.push(5-reportMarkerData[i][8]);
                }
              }

              console.log(rep_safety_arr);
              console.log(rep_again_arr);

              var pol_safety = (Math.log10(((cnt/boundarea)/pol_dense) + 0.01)+2)*5;
              var rep_safety = ((rep_safety_arr.reduce((a,b) => a + b, 0) / rep_safety_arr.length)/4)*10;
              var rep_again = ((rep_again_arr.reduce((a,b) => a + b, 0) / rep_again_arr.length)/4)*10;
              var rev_safety = 0
              var crime_ave = 0

              if (isNaN(rep_safety)) {
                rep_safety = 0
              }

              if (isNaN(rep_again)) {
                rep_again = 0
              }

              if (isNaN(rev_safety)) {
                rev_safety = 0
              }

              const tot_safety = 0 * pol_safety + 0 * rep_safety + 1 * rep_again + 0 * rev_safety + 0 * crime_ave;
              document.getElementById("DRating").innerHTML = tot_safety.toFixed(2);
            }
            
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //---------------------------------------------------------------
            //vegalite things
            vega.scheme('Tol_muted', ['#88ccee', '#44aa99', '#117733', '#332288', '#ddcc77', '#999933', '#cc6677', '#882255', '#aa4499', '#dddddd']);
            vega.scheme('Tol_light', ['#bbcc33', '#aaaa00', '#77aadd', '#ee8866', '#ddcc77', '#eedd88', '#ffaabb', '#99ddff', '#44bb99', '#dddddd']);
          
            var bubble = "static/js/Info_bubble.vg.json";
            vegaEmbed('#Info_bubble', bubble, {"actions": false}).then(function(result) {
              // Access the Vega view instance (https://vega.github.io/vega/docs/api/view/) as result.view
            }).catch(console.error);
            
          </script>
    </body>
</html>